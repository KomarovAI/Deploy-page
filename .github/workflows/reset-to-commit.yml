name: ğŸ”„ Reset Repository to Commit

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'ğŸ“¦ Target repository (owner/repo format)'
        required: true
        type: string
        default: 'KomarovAI/archived-sites'
      target_commit:
        description: 'ğŸ¯ Target commit hash to reset to'
        required: true
        type: string
      target_branch:
        description: 'ğŸŒ¿ Target branch to reset'
        required: false
        type: string
        default: 'main'
      force_push:
        description: 'âš ï¸ Use force push (overwrite remote history)'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  reset:
    runs-on: ubuntu-latest
    name: ğŸ”„ Reset ${{ github.event.inputs.target_repo }}
    
    steps:
      - name: ğŸ“‹ Validate inputs
        run: |
          REPO="${{ github.event.inputs.target_repo }}"
          COMMIT="${{ github.event.inputs.target_commit }}"
          BRANCH="${{ github.event.inputs.target_branch }}"
          
          # Validate repo format
          if [[ ! "$REPO" =~ ^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+$ ]]; then
            echo "âŒ Invalid repository format: $REPO"
            echo "âœ… Correct format: owner/repo (e.g., KomarovAI/archived-sites)"
            exit 1
          fi
          
          # Validate commit hash format
          if [[ ! "$COMMIT" =~ ^[a-f0-9]{7,40}$ ]]; then
            echo "âŒ Invalid commit hash: $COMMIT"
            echo "âœ… Commit must be 7-40 hex characters"
            exit 1
          fi
          
          # Validate branch name
          if [[ ! "$BRANCH" =~ ^[a-zA-Z0-9_/-]+$ ]]; then
            echo "âŒ Invalid branch name: $BRANCH"
            exit 1
          fi
          
          echo "âœ… Input validation passed"
          echo "  Repository: $REPO"
          echo "  Commit: $COMMIT"
          echo "  Branch: $BRANCH"

      - name: ğŸ“¥ Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.target_repo }}
          ref: ${{ github.event.inputs.target_branch }}
          fetch-depth: 0
          token: ${{ secrets.EXTERNAL_REPO_PAT }}

      - name: âš™ï¸ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "Git configured:"
          git config --list | grep -E "(user|url)" | head -5

      - name: ğŸ” Validate target commit exists
        run: |
          COMMIT="${{ github.event.inputs.target_commit }}"
          REPO="${{ github.event.inputs.target_repo }}"
          
          if ! git cat-file -t "$COMMIT" > /dev/null 2>&1; then
            echo "âŒ Commit $COMMIT not found in $REPO!"
            echo ""
            echo "ğŸ“‹ Recent commits in repository:"
            git log --oneline -10
            exit 1
          fi
          
          echo "âœ… Commit found!"
          echo ""
          git log -1 --format="ğŸ“‹ Commit Details:%n  Hash: %H%n  Author: %an%n  Date: %ai%n  Message: %s" "$COMMIT"

      - name: ğŸ”„ Reset to target commit
        run: |
          COMMIT="${{ github.event.inputs.target_commit }}"
          BRANCH="${{ github.event.inputs.target_branch }}"
          
          echo "ğŸ”„ Resetting $BRANCH to $COMMIT"
          git reset --hard "$COMMIT"
          
          echo ""
          echo "âœ… Reset complete!"
          echo "ğŸ“ Current HEAD:"
          git log -1 --oneline

      - name: ğŸ“Š Show commit details
        run: |
          echo "ğŸ“Š Reset Statistics:"
          git log -1 --format="
          ========================
          Commit Hash: %H
          Short Hash: %h
          Author: %an <%ae>
          Date: %ai
          Message: %s
          ========================"

      - name: ğŸš€ Push changes to remote
        run: |
          BRANCH="${{ github.event.inputs.target_branch }}"
          REPO="${{ github.event.inputs.target_repo }}"
          
          echo "ğŸš€ Pushing to origin/$BRANCH"
          
          if [ "${{ github.event.inputs.force_push }}" = "true" ]; then
            echo "âš ï¸  Using force push (--force-with-lease)"
            echo "   This will overwrite remote history!"
            git push --force-with-lease origin "$BRANCH"
            echo "âœ… Force push complete!"
          else
            echo "ğŸ“¤ Using safe push"
            if git push origin "$BRANCH" 2>&1 | grep -q "non-fast-forward"; then
              echo "âš ï¸  Push rejected: repository has diverged"
              echo "   Use force_push: true to overwrite remote"
              exit 1
            fi
            echo "âœ… Safe push complete!"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.EXTERNAL_REPO_PAT }}

      - name: ğŸ“‹ Create detailed summary
        if: success()
        run: |
          REPO="${{ github.event.inputs.target_repo }}"
          COMMIT="${{ github.event.inputs.target_commit }}"
          BRANCH="${{ github.event.inputs.target_branch }}"
          FORCE="${{ github.event.inputs.force_push }}"
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## âœ… Repository Reset Successful
          
          | Parameter | Value |
          |-----------|-------|
          | **Repository** | `${{ inputs.target_repo }}` |
          | **Target Commit** | `${{ inputs.target_commit }}` |
          | **Branch** | `${{ inputs.target_branch }}` |
          | **Force Push** | ${{ inputs.force_push }} |
          | **Timestamp** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |
          
          ### ğŸ“ Current State
          EOF
          
          git log -1 --format="
          - **Commit Hash:** \`%H\`
          - **Short Hash:** \`%h\`
          - **Author:** %an
          - **Date:** %ai
          - **Message:** %s
          " >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“š Last 5 Commits" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git log --oneline -5 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: âŒ Report failure
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## âŒ Reset Failed
          
          **Please check:**
          - âœ“ Repository format: `owner/repo` (e.g., `KomarovAI/archived-sites`)
          - âœ“ Commit hash is valid (7-40 hex characters)
          - âœ“ Commit exists in the repository
          - âœ“ Branch name is correct
          - âœ“ You have write permissions to the repository
          - âœ“ EXTERNAL_REPO_PAT secret is configured and has write permissions
          
          **Common Issues:**
          - Invalid repository format
          - Commit not found
          - Branch doesn't exist
          - Force push disabled and history diverged
          - EXTERNAL_REPO_PAT not configured or expired
          EOF
