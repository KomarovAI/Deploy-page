name: Deploy to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      runid:
        description: 'Run ID from web-crawler'
        required: true
      sourcerepo:
        description: 'Source repository (owner/repo)'
        required: true
        default: 'KomarovAI/web-crawler'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Download artifact from web-crawler
        uses: dawidd6/action-download-artifact@v12
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ github.event.inputs.sourcerepo }}
          run_id: ${{ github.event.inputs.runid }}
          path: site-content
          search_artifacts: true
          workflow_conclusion: success

      - name: Fix flattened file structure (bash only)
        run: |
          echo "ðŸ”§ Restructuring files for GitHub Pages..."
          cd site-content
          
          # Extract from nested directory if exists
          NESTED=$(find . -mindepth 1 -maxdepth 1 -type d | head -1)
          if [ -n "$NESTED" ]; then
            echo "ðŸ“¦ Found nested: $NESTED"
            mv "$NESTED"/* ./ 2>/dev/null || true
            rmdir "$NESTED" 2>/dev/null || true
          fi
          
          echo "ðŸ“ Creating directory structure..."
          
          # Process HTML files with flattened names
          for file in *.html; do
            [ "$file" = "*.html" ] && break  # No HTML files
            [ "$file" = "index.html" ] && continue
            [ "$file" = "404.html" ] && continue
            
            name="${file%.html}"
            
            # Match known prefixes using case/esac
            case "$name" in
              sectors*)
                rest="${name#sectors}"
                mkdir -p "sectors$rest"
                mv "$file" "sectors$rest/index.html"
                echo "  âœ“ $file â†’ sectors$rest/index.html"
                ;;
              services*)
                rest="${name#services}"
                mkdir -p "services$rest"
                mv "$file" "services$rest/index.html"
                echo "  âœ“ $file â†’ services$rest/index.html"
                ;;
              category*)
                rest="${name#category}"
                mkdir -p "category$rest"
                mv "$file" "category$rest/index.html"
                echo "  âœ“ $file â†’ category$rest/index.html"
                ;;
              news*)
                rest="${name#news}"
                mkdir -p "news$rest"
                mv "$file" "news$rest/index.html"
                echo "  âœ“ $file â†’ news$rest/index.html"
                ;;
              *)
                # Other files: name.html -> name/index.html
                mkdir -p "$name"
                mv "$file" "$name/index.html"
                echo "  âœ“ $file â†’ $name/index.html"
                ;;
            esac
          done
          
          echo "âœ… Structure ready!"
          echo ""
          echo "Final structure:"
          find . -name 'index.html' | head -20

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: site-content

      - name: Deploy to GitHub Pages  
        id: deployment
        uses: actions/deploy-pages@v4
