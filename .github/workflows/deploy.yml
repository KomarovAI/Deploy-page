name: Deploy Website to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID from web-crawler workflow'
        required: true
      artifact_name:
        description: 'Artifact name (default: auto-detect from run_id)'
        required: false
        default: ''
      source_repo:
        description: 'Source repository (owner/repo)'
        required: false
        default: 'KomarovAI/web-crawler'
      target_repo:
        description: 'Target repository (owner/repo)'
        required: false
        default: 'KomarovAI/archived-sites'
      target_branch:
        description: 'Target branch'
        required: false
        default: 'main'
      base_path:
        description: 'Base path for GitHub Pages (e.g. /archived-sites)'
        required: false
        default: '/archived-sites'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    outputs:
      commit_sha: ${{ steps.commit.outputs.commit_sha }}
      deployed_files: ${{ steps.copy.outputs.deployedfiles }}
    
    steps:
      - name: Validate inputs
        id: inputs
        shell: bash
        run: |
          RUN_ID="${{ github.event.inputs.run_id }}"
          if ! [[ $RUN_ID =~ ^[0-9]+$ ]]; then
            echo "Invalid run_id: $RUN_ID"
            exit 1
          fi
          
          SOURCE_REPO="${{ github.event.inputs.source_repo }}"
          SOURCE_REPO=$(echo "$SOURCE_REPO" | xargs)
          if ! [[ $SOURCE_REPO =~ ^[a-zA-Z0-9][a-zA-Z0-9.-]*[a-zA-Z0-9]?/[a-zA-Z0-9][a-zA-Z0-9._-]*[a-zA-Z0-9]?$ ]]; then
            echo "Invalid source_repo: $SOURCE_REPO"
            exit 1
          fi
          
          TARGET_REPO="${{ github.event.inputs.target_repo }}"
          TARGET_REPO=$(echo "$TARGET_REPO" | xargs)
          if ! [[ $TARGET_REPO =~ ^[a-zA-Z0-9][a-zA-Z0-9.-]*[a-zA-Z0-9]?/[a-zA-Z0-9][a-zA-Z0-9._-]*[a-zA-Z0-9]?$ ]]; then
            echo "Invalid target_repo: $TARGET_REPO"
            exit 1
          fi
          
          ARTIFACT_NAME="${{ github.event.inputs.artifact_name }}"
          if [ -z "$ARTIFACT_NAME" ]; then
            ARTIFACT_NAME="*-${RUN_ID}"
          fi
          
          echo "run_id=${RUN_ID}" >> $GITHUB_OUTPUT
          echo "source_repo=${SOURCE_REPO}" >> $GITHUB_OUTPUT
          echo "target_repo=${TARGET_REPO}" >> $GITHUB_OUTPUT
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          echo "âœ… Inputs validated"

      - name: Checkout Deploy-page scripts
        uses: actions/checkout@v6
        with:
          repository: KomarovAI/Deploy-page
          ref: main
          path: deploy-page-repo
          fetch-depth: 1

      - name: Install dependencies
        run: |
          python3 -m pip install -q --upgrade pip
          pip3 install -q beautifulsoup4 lxml

      - name: Download artifact
        uses: dawidd6/action-download-artifact@v12
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ steps.inputs.outputs.source_repo }}
          run_id: ${{ steps.inputs.outputs.run_id }}
          name: ${{ steps.inputs.outputs.artifact_name }}
          path: site-content
          search_artifacts: true

      - name: Verify artifact
        id: verify
        run: |
          if [ ! -d "site-content" ] || [ -z "$(ls -A site-content)" ]; then
            echo "âŒ Artifact not found"
            exit 1
          fi
          FILE_COUNT=$(find site-content -type f | wc -l)
          echo "file_count=${FILE_COUNT}" >> $GITHUB_OUTPUT
          echo "âœ… Artifact verified: ${FILE_COUNT} files"

      - name: Checkout target repository
        uses: actions/checkout@v6
        with:
          repository: ${{ steps.inputs.outputs.target_repo }}
          token: ${{ secrets.EXTERNAL_REPO_PAT }}
          ref: ${{ github.event.inputs.target_branch }}
          fetch-depth: 0
          path: target-repo

      - name: Configure Git
        working-directory: target-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create snapshot
        id: snapshot
        working-directory: target-repo
        run: |
          SNAPSHOT_SHA=$(git rev-parse HEAD)
          echo "snapshot_sha=${SNAPSHOT_SHA}" >> $GITHUB_OUTPUT
          echo "ðŸ“¸ Snapshot: ${SNAPSHOT_SHA}"

      - name: ATOMIC CLEANUP via temp branch
        working-directory: target-repo
        run: |
          echo "ðŸ§¹ Creating clean deploy branch..."
          git checkout -b deploy-temp
          
          # Remove ALL except .git and .github
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' -exec rm -rf {} +
          
          # CRITICAL: Verify cleanup
          REMAINING=$(find . -mindepth 1 -type f ! -path '*/.git/*' ! -path '*/.github/*' | wc -l)
          if [ $REMAINING -ne 0 ]; then
            echo "âŒ FATAL: $REMAINING files remain!"
            find . -mindepth 1 -type f ! -path '*/.git/*' ! -path '*/.github/*'
            exit 1
          fi
          echo "âœ… Repository cleaned"

      - name: Copy new site
        id: copy
        working-directory: target-repo
        run: |
          SOURCE_FILES=$(find "$GITHUB_WORKSPACE/site-content" -type f | wc -l)
          
          SUBDIRS=$(find "$GITHUB_WORKSPACE/site-content" -mindepth 1 -maxdepth 1 -type d | wc -l)
          if [ $SUBDIRS -eq 1 ]; then
            SUBDIR=$(find "$GITHUB_WORKSPACE/site-content" -mindepth 1 -maxdepth 1 -type d | head -1)
            cp -r "$SUBDIR"/* .
          else
            cp -r "$GITHUB_WORKSPACE/site-content"/* .
          fi
          
          DEST_FILES=$(find . -mindepth 1 -type f ! -path '*/.git/*' ! -path '*/.github/*' | wc -l)
          if [ $SOURCE_FILES -ne $DEST_FILES ]; then
            echo "âŒ File count mismatch"
            exit 1
          fi
          
          echo "deployed_files=${DEST_FILES}" >> $GITHUB_OUTPUT
          echo "âœ… Copied ${DEST_FILES} files"

      - name: Convert WordPress
        working-directory: target-repo
        env:
          BASE_PATH: ${{ github.event.inputs.base_path }}
        run: |
          python3 "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/wp-to-static.py"

      - name: Validate
        working-directory: target-repo
        run: |
          if [ ! -f "index.html" ]; then
            echo "âŒ index.html missing!"
            exit 1
          fi
          HTML_COUNT=$(find . -name '*.html' -type f | wc -l)
          if [ $HTML_COUNT -eq 0 ]; then
            echo "âŒ No HTML files!"
            exit 1
          fi
          echo "âœ… Validation passed: ${HTML_COUNT} HTML files"

      - name: Atomic commit
        id: commit
        working-directory: target-repo
        run: |
          git add -A
          
          if git diff --cached --quiet; then
            CHANGED_FILES=0
          else
            CHANGED_FILES=$(git diff --cached --name-only | wc -l)
          fi
          
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          git commit --allow-empty -m "deploy: run ${{ steps.inputs.outputs.run_id }} at ${TIMESTAMP}"
          
          # Merge to main
          git checkout ${{ github.event.inputs.target_branch }}
          git merge --ff-only deploy-temp
          git branch -d deploy-temp
          
          git push origin ${{ github.event.inputs.target_branch }}
          
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "âœ… Deployed: ${CHANGED_FILES} changes"

      - name: Rollback on failure
        if: failure()
        working-directory: target-repo
        run: |
          echo "âš ï¸ Rolling back to ${{ steps.snapshot.outputs.snapshot_sha }}"
          git checkout ${{ github.event.inputs.target_branch }}
          git reset --hard ${{ steps.snapshot.outputs.snapshot_sha }}
          git push origin ${{ github.event.inputs.target_branch }} --force

      - name: Summary
        if: always()
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "## âœ… SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "Commit: ${{ steps.commit.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ FAILED - Rolled back" >> $GITHUB_STEP_SUMMARY
          fi
