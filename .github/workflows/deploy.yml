name: Deploy Website to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID from web-crawler workflow'
        required: true
      artifact_name:
        description: 'Artifact name (default: auto-detect from run_id)'
        required: false
        default: ''
      source_repo:
        description: 'Source repository (owner/repo)'
        required: false
        default: 'KomarovAI/web-crawler'
      target_repo:
        description: 'Target repository (owner/repo)'
        required: false
        default: 'KomarovAI/archived-sites'
      target_branch:
        description: 'Target branch'
        required: false
        default: 'main'
      base_href:
        description: 'Base href for GitHub Pages (e.g., / or /archived-sites/)'
        required: false
        default: '/'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    outputs:
      commit_sha: ${{ steps.commit.outputs.commit_sha }}
      deployed_files: ${{ steps.copy.outputs.deployedfiles }}
      github_pages_url: ${{ steps.pages_url.outputs.url }}
    
    steps:
      # Step 1: Validate and normalize inputs
      - name: Validate inputs
        id: inputs
        shell: bash
        run: |
          echo "Validating inputs..."
          
          # Run ID
          RUN_ID="${{ github.event.inputs.run_id }}"
          if ! [[ $RUN_ID =~ ^[0-9]+$ ]]; then
            echo "Invalid run_id format: $RUN_ID"
            exit 1
          fi
          
          # Source repository
          SOURCE_REPO="${{ github.event.inputs.source_repo }}"
          SOURCE_REPO=$(echo "$SOURCE_REPO" | xargs)
          if ! [[ $SOURCE_REPO =~ ^[a-zA-Z0-9][a-zA-Z0-9.-]*[a-zA-Z0-9]?/[a-zA-Z0-9][a-zA-Z0-9._-]*[a-zA-Z0-9]?$ ]]; then
            echo "Invalid source_repo format: $SOURCE_REPO"
            exit 1
          fi
          
          # Target repository  
          TARGET_REPO="${{ github.event.inputs.target_repo }}"
          TARGET_REPO=$(echo "$TARGET_REPO" | xargs)
          if ! [[ $TARGET_REPO =~ ^[a-zA-Z0-9][a-zA-Z0-9.-]*[a-zA-Z0-9]?/[a-zA-Z0-9][a-zA-Z0-9._-]*[a-zA-Z0-9]?$ ]]; then
            echo "Invalid target_repo format: $TARGET_REPO"
            exit 1
          fi
          
          # Base href
          BASE_HREF="${{ github.event.inputs.base_href }}"
          if ! [[ $BASE_HREF =~ ^[./]*$ ]]; then
            echo "Invalid base_href: $BASE_HREF"
            exit 1
          fi
          
          # Normalize base_href (add trailing slash if not root)
          if [[ ! -z "$BASE_HREF" && "$BASE_HREF" != "/" ]]; then
            BASE_HREF="${BASE_HREF%/}/"  # Remove trailing slash, then add it
          fi
          
          # Artifact name - use input or pattern matching
          ARTIFACT_NAME="${{ github.event.inputs.artifact_name }}"
          if [ -z "$ARTIFACT_NAME" ]; then
            # Auto-detect: try pattern *-${RUN_ID}
            echo "‚ö†Ô∏è Artifact name not provided, will use pattern matching: *-${RUN_ID}"
            ARTIFACT_NAME="*-${RUN_ID}"
          fi
          
          echo "run_id=${RUN_ID}" >> $GITHUB_OUTPUT
          echo "source_repo=${SOURCE_REPO}" >> $GITHUB_OUTPUT
          echo "target_repo=${TARGET_REPO}" >> $GITHUB_OUTPUT
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          echo "base_href=${BASE_HREF}" >> $GITHUB_OUTPUT
          echo "Inputs validated"
          echo ""
          echo "Parameters:"
          echo "- Run ID: ${RUN_ID}"
          echo "- Source: ${SOURCE_REPO}"
          echo "- Target: ${TARGET_REPO}"
          echo "- Branch: ${{ github.event.inputs.target_branch }}"
          echo "- Base href: ${BASE_HREF}"
          echo "- Artifact: ${ARTIFACT_NAME}"

      # Step 2: Checkout Deploy-page repo (FORCE FRESH - NO CACHE)
      - name: Checkout Deploy-page scripts
        uses: actions/checkout@v6
        with:
          repository: KomarovAI/Deploy-page
          ref: main
          path: deploy-page-repo
          fetch-depth: 1
          clean: true

      # Step 3: Verify script versions
      - name: Verify script versions
        continue-on-error: true
        run: |
          echo "üîç Verifying script versions..."
          cd deploy-page-repo
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Current commit short: $(git rev-parse --short HEAD)"
          echo "fix-static-site.py modified: $(git log -1 --format=%ci .github/scripts/fix-static-site.py)" || echo "Script file not found"
          echo ""

      # Step 4: Install Python dependencies
      - name: Install Python dependencies
        run: |
          echo "üì¶ Installing Python dependencies..."
          python3 -m pip install --upgrade pip > /dev/null 2>&1
          pip3 install beautifulsoup4 lxml rich pydantic > /dev/null 2>&1
          echo "‚úÖ Dependencies installed successfully"

      # Step 5: Download artifact from source workflow
      - name: Download site archive
        uses: dawidd6/action-download-artifact@v12
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ steps.inputs.outputs.source_repo }}
          run_id: ${{ steps.inputs.outputs.run_id }}
          name: ${{ steps.inputs.outputs.artifact_name }}
          path: site-content
          search_artifacts: true

      # Step 6: Verify artifact
      - name: Verify artifact
        id: verify
        shell: bash
        run: |
          if [ ! -d "site-content" ] || [ -z "$(ls -A site-content 2>/dev/null)" ]; then
            echo "‚ùå Artifact not found or empty"
            echo "Contents:"
            ls -R . || true
            exit 1
          fi
          FILE_COUNT=$(find site-content -type f | wc -l)
          DIR_SIZE=$(du -sh site-content | cut -f1)
          echo "file_count=${FILE_COUNT}" >> $GITHUB_OUTPUT
          echo "dir_size=${DIR_SIZE}" >> $GITHUB_OUTPUT
          echo "‚úÖ Artifact verified: ${FILE_COUNT} files (${DIR_SIZE})"

      # Step 7: Checkout target repository
      - name: Checkout target repository
        uses: actions/checkout@v6
        with:
          repository: ${{ steps.inputs.outputs.target_repo }}
          token: ${{ secrets.EXTERNAL_REPO_PAT }}
          ref: ${{ github.event.inputs.target_branch }}
          fetch-depth: 0
          path: target-repo

      # Step 8: Configure Git
      - name: Configure Git
        working-directory: target-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "‚úÖ Git configured"

      # Step 9: Create snapshot for rollback
      - name: Create snapshot
        id: snapshot
        working-directory: target-repo
        run: |
          SNAPSHOT_SHA=$(git rev-parse HEAD)
          echo "snapshot_sha=${SNAPSHOT_SHA}" >> $GITHUB_OUTPUT
          echo "üì∏ Snapshot created: ${SNAPSHOT_SHA}"

      # Step 10: COMPLETE CLEANUP
      - name: Clean repository
        working-directory: target-repo
        run: |
          echo "üßπ FULL REPOSITORY CLEANUP..."
          
          # Count files before cleanup
          BEFORE_COUNT=$(find . -mindepth 1 -type f ! -path '*/.git/*' ! -path '*/.github/*' | wc -l 2>/dev/null || echo 0)
          echo "Files before cleanup: $BEFORE_COUNT"
          
          # CRITICAL: Remove EVERYTHING except .git and .github
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' -type d -exec rm -rf {} + 2>/dev/null || true
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' -type f -delete 2>/dev/null || true
          
          # Verify cleanup
          AFTER_COUNT=$(find . -mindepth 1 -type f ! -path '*/.git/*' ! -path '*/.github/*' | wc -l 2>/dev/null || echo 0)
          
          if [ "$AFTER_COUNT" -eq 0 ]; then
            echo "‚úÖ Repository cleaned: $BEFORE_COUNT files removed"
          else
            echo "‚ö†Ô∏è Warning: $AFTER_COUNT files remaining after cleanup"
            find . -mindepth 1 -type f ! -path '*/.git/*' ! -path '*/.github/*' -delete 2>/dev/null || true
            AFTER_COUNT=$(find . -mindepth 1 -type f ! -path '*/.git/*' ! -path '*/.github/*' | wc -l 2>/dev/null || echo 0)
            echo "‚úÖ Force cleanup done: $AFTER_COUNT remaining"
          fi

      # Step 11: Copy website files
      - name: Copy website files
        id: copy
        working-directory: target-repo
        run: |
          echo "üì¶ Copying website files..."
          
          if [ ! -d "$GITHUB_WORKSPACE/site-content" ]; then
            echo "‚ùå Source directory not found"
            exit 1
          fi
          
          SOURCE_FILES=$(find "$GITHUB_WORKSPACE/site-content" -type f 2>/dev/null | wc -l || echo 0)
          SUBDIRS=$(find "$GITHUB_WORKSPACE/site-content" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l || echo 0)
          
          echo "Source files: $SOURCE_FILES, subdirs: $SUBDIRS"
          
          if [ $SUBDIRS -eq 1 ]; then
            SUBDIR=$(find "$GITHUB_WORKSPACE/site-content" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | head -1)
            SUBDIR_NAME=$(basename "$SUBDIR")
            echo "  ‚Ü≥ Nested structure detected: ${SUBDIR_NAME}"
            cp -r "$SUBDIR"/* . 2>/dev/null || {
              echo "Copy failed, trying alternative method..."
              cp -r "$SUBDIR"/.  ./ 2>/dev/null || true
            }
          else
            cp -r "$GITHUB_WORKSPACE/site-content"/* . 2>/dev/null || {
              echo "Copy failed, trying alternative method..."
              cp -r "$GITHUB_WORKSPACE/site-content"/. . 2>/dev/null || true
            }
          fi
          
          DEST_FILES=$(find "$GITHUB_WORKSPACE/target-repo" -mindepth 1 -type f ! -path '*/.git/*' ! -path '*/.github/*' 2>/dev/null | wc -l || echo 0)
          echo "deployed_files=${DEST_FILES}" >> $GITHUB_OUTPUT
          echo "‚úÖ Copied ${DEST_FILES} files"
          
          if [ "$DEST_FILES" -eq 0 ]; then
            echo "‚ö†Ô∏è Warning: No files copied!"
            ls -la "$GITHUB_WORKSPACE/site-content/" || true
          fi

      # Step 12: Fix paths for GitHub Pages (OPTIONAL - continue if fails)
      - name: Fix paths
        working-directory: target-repo
        env:
          BASE_HREF: ${{ steps.inputs.outputs.base_href }}
        continue-on-error: true
        run: |
          echo "üîß Fixing paths for GitHub Pages..."
          
          if [ ! -f "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/fix-paths.py" ]; then
            echo "‚ö†Ô∏è fix-paths.py not found, skipping"
            exit 0
          fi
          
          python3 "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/fix-paths.py" || echo "‚ö†Ô∏è Path fixing script failed, continuing..."
          echo "‚úÖ Paths processed"

      # Step 13: Calculate path mapping (OPTIONAL - continue if fails)
      - name: Calculate path mapping
        working-directory: target-repo
        id: mapping
        continue-on-error: true
        run: |
          echo "üìç Calculating path mappings for link rewriting..."
          python3 "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/normalize-paths.py" . 2>&1 | tee -a $GITHUB_STEP_SUMMARY || echo "‚ö†Ô∏è Path mapping failed, continuing..."
          if [ -f path-mapping.json ]; then
            MAPPING_SIZE=$(wc -l < path-mapping.json 2>/dev/null || echo 0)
            echo "mapping_lines=${MAPPING_SIZE}" >> $GITHUB_OUTPUT
            echo "‚úÖ Path mapping created"
          else
            echo "‚ö†Ô∏è Path mapping not created, will continue without it"
          fi

      # Step 14: Fix links using lxml (OPTIONAL - continue if fails)
      - name: Fix links with lxml
        working-directory: target-repo
        id: fix_links
        continue-on-error: true
        run: |
          echo "üîó Rewriting links..."
          
          if [ -f path-mapping.json ]; then
            python3 "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/fix-links.py" . path-mapping.json 2>&1 | tee -a $GITHUB_STEP_SUMMARY || echo "‚ö†Ô∏è Link fixing failed, continuing..."
          else
            echo "‚ö†Ô∏è No path mapping available, skipping link rewriting"
          fi
          echo "‚úÖ Link processing complete"

      # Step 15: Fix static site issues (OPTIONAL - continue if fails)
      - name: Fix static site issues
        working-directory: target-repo
        continue-on-error: true
        run: |
          echo "üî® Applying static site fixes..."
          
          if [ ! -f "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/fix-static-site.py" ]; then
            echo "‚ö†Ô∏è fix-static-site.py not found, skipping"
            exit 0
          fi
          
          python3 "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/fix-static-site.py" 2>&1 | tail -20 || echo "‚ö†Ô∏è Static site fixing had issues, continuing..."
          echo "‚úÖ Static site processing complete"

      # Step 16: Validate links for 404s (OPTIONAL - never fail)
      - name: Validate links
        working-directory: target-repo
        id: validate
        continue-on-error: true
        run: |
          echo "üîç Validating links..."
          python3 "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/validate-links.py" . || true
          
          if [ -f broken-links.json ]; then
            BROKEN_COUNT=$(grep -o '"source"' broken-links.json 2>/dev/null | wc -l || echo 0)
            echo "broken_links=${BROKEN_COUNT}" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Found ${BROKEN_COUNT} broken links (see report)"
          else
            echo "broken_links=0" >> $GITHUB_OUTPUT
            echo "‚úÖ Link validation complete"
          fi

      # Step 17: Validate deployment (OPTIONAL - never fail)
      - name: Validate deployment
        working-directory: target-repo
        env:
          BASE_HREF: ${{ steps.inputs.outputs.base_href }}
        continue-on-error: true
        run: |
          echo "‚úîÔ∏è Validating deployment..."
          
          if [ ! -f "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/validate-deploy.py" ]; then
            echo "‚ö†Ô∏è validate-deploy.py not found, skipping"
            exit 0
          fi
          
          python3 "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/validate-deploy.py" || echo "‚ö†Ô∏è Validation warnings, continuing..."
          echo "‚úÖ Validation complete"

      # Step 18: Commit and push (CRITICAL - MUST SUCCEED)
      - name: Commit and push
        id: commit
        working-directory: target-repo
        run: |
          echo "üì§ Committing changes..."
          
          git add -A
          
          CHANGED_FILES=$(git diff --cached --name-only 2>/dev/null | wc -l || echo 0)
          echo "Changed files: $CHANGED_FILES"
          
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          git commit --allow-empty -m "deploy: run ${{ steps.inputs.outputs.run_id }} at ${TIMESTAMP}" || {
            echo "‚ö†Ô∏è Commit failed, force pushing..."
            git push origin ${{ github.event.inputs.target_branch }} --force-with-lease || git push origin ${{ github.event.inputs.target_branch }} --force || true
          }
          
          git push origin ${{ github.event.inputs.target_branch }} || git push origin ${{ github.event.inputs.target_branch }} --force-with-lease || git push origin ${{ github.event.inputs.target_branch }} --force || {
            echo "‚ùå Push failed after 3 attempts"
            exit 1
          }
          
          COMMIT_SHA=$(git rev-parse HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "changed_files=${CHANGED_FILES}" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Deployed: ${SHORT_SHA} (${CHANGED_FILES} files changed)"

      # Step 19: PAUSE FOR GITHUB PAGES BUILD
      - name: Wait for GitHub Pages build
        id: pages_url
        run: |
          echo "‚è≥ GitHub Pages is rebuilding your site..."
          echo ""
          echo "Waiting 15 seconds for Pages build to start..."
          sleep 15
          
          TARGET_REPO="${{ steps.inputs.outputs.target_repo }}"
          OWNER=$(echo $TARGET_REPO | cut -d'/' -f1)
          REPO=$(echo $TARGET_REPO | cut -d'/' -f2)
          
          # Construct GitHub Pages URL
          PAGES_URL="https://${OWNER}.github.io/${REPO}/"
          
          echo "url=${PAGES_URL}" >> $GITHUB_OUTPUT
          echo ""
          echo "üåê GitHub Pages URL: ${PAGES_URL}"
          echo ""
          echo "Your site will be live in 2-3 minutes!"
          echo "‚è≥ Initial build: 2-3 minutes"
          echo "üìù CDN cache clear: up to 5 minutes"
          echo ""
          echo "Check build status:"
          echo "https://github.com/${TARGET_REPO}/deployments/activity_log"

      # Step 20: Deployment summary
      - name: Deployment summary
        if: always()
        run: |
          echo "# üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "## ‚úÖ Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Details" >> $GITHUB_STEP_SUMMARY
            echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Repository | \`${{ steps.inputs.outputs.target_repo }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Branch | \`${{ github.event.inputs.target_branch }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Commit | [\`${{ steps.commit.outputs.short_sha }}\`](https://github.com/${{ steps.inputs.outputs.target_repo }}/commit/${{ steps.commit.outputs.commit_sha }}) |" >> $GITHUB_STEP_SUMMARY
            echo "| Files Changed | ${{ steps.commit.outputs.changed_files }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Files Deployed | ${{ steps.copy.outputs.deployedfiles }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Size | ${{ steps.verify.outputs.dir_size }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Base href | \`${{ steps.inputs.outputs.base_href }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Broken Links | ${{ steps.validate.outputs.broken_links }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Pages URL | [${{ steps.pages_url.outputs.url }}](${{ steps.pages_url.outputs.url }}) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Timeline" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Downloaded artifact (${{ steps.verify.outputs.file_count }} files)" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Cleaned & copied to repository" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Fixed paths for GitHub Pages" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Calculated path mappings" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Rewrote all links with lxml" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Applied static site fixes" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Validated links for 404s" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Committed & pushed to GitHub" >> $GITHUB_STEP_SUMMARY
            echo "- ‚è≥ GitHub Pages build in progress (2-3 minutes)" >> $GITHUB_STEP_SUMMARY
            echo "- üåê Live at: [${{ steps.pages_url.outputs.url }}](${{ steps.pages_url.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Status: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Snapshot SHA for rollback: \`${{ steps.snapshot.outputs.snapshot_sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To restore from snapshot:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "git reset --hard ${{ steps.snapshot.outputs.snapshot_sha }}" >> $GITHUB_STEP_SUMMARY
            echo "git push --force-with-lease" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
