name: Deploy to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      runid:
        description: 'Run ID from web-crawler'
        required: true
      sourcerepo:
        description: 'Source repository (owner/repo)'
        required: true
        default: 'KomarovAI/web-crawler'
      basepath:
        description: 'Base path (e.g., /Deploy-page/ or / for root)'
        required: false
        default: '/Deploy-page/'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Download artifact from web-crawler
        uses: dawidd6/action-download-artifact@v12
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ github.event.inputs.sourcerepo }}
          run_id: ${{ github.event.inputs.runid }}
          path: site-content
          search_artifacts: true
          workflow_conclusion: success

      - name: Fix flattened file structure
        run: |
          echo "ðŸ”§ Restructuring files for GitHub Pages..."
          cd site-content
          
          # Extract from nested directory if exists
          NESTED=$(find . -mindepth 1 -maxdepth 1 -type d | head -1)
          if [ -n "$NESTED" ]; then
            echo "ðŸ“¦ Found nested: $NESTED"
            mv "$NESTED"/* ./ 2>/dev/null || true
            rmdir "$NESTED" 2>/dev/null || true
          fi
          
          echo "ðŸ“ Creating directory structure..."
          
          # Process HTML files with flattened names
          for file in *.html; do
            [ "$file" = "*.html" ] && break
            [ "$file" = "index.html" ] && continue
            [ "$file" = "404.html" ] && continue
            
            name="${file%.html}"
            
            case "$name" in
              sectors*)
                rest="${name#sectors}"
                mkdir -p "sectors$rest"
                mv "$file" "sectors$rest/index.html"
                echo "  âœ“ $file â†’ sectors$rest/index.html"
                ;;
              services*)
                rest="${name#services}"
                mkdir -p "services$rest"
                mv "$file" "services$rest/index.html"
                echo "  âœ“ $file â†’ services$rest/index.html"
                ;;
              category*)
                rest="${name#category}"
                mkdir -p "category$rest"
                mv "$file" "category$rest/index.html"
                echo "  âœ“ $file â†’ category$rest/index.html"
                ;;
              news*)
                rest="${name#news}"
                mkdir -p "news$rest"
                mv "$file" "news$rest/index.html"
                echo "  âœ“ $file â†’ news$rest/index.html"
                ;;
              *)
                mkdir -p "$name"
                mv "$file" "$name/index.html"
                echo "  âœ“ $file â†’ $name/index.html"
                ;;
            esac
          done
          
          echo "âœ… Structure ready!"

      - name: Fix paths for GitHub Pages
        run: |
          echo "ðŸ”— Fixing URLs for base path: ${{ github.event.inputs.basepath }}"
          cd site-content
          
          cat > fix_paths.py << 'PYTHON_SCRIPT'
          import re
          import sys
          from pathlib import Path
          
          BASE_PATH = "${{ github.event.inputs.basepath }}".rstrip('/') + '/'
          if BASE_PATH == '//': BASE_PATH = '/'
          
          print(f"Base path: {BASE_PATH}")
          
          def fix_html(file_path):
              try:
                  content = file_path.read_text(encoding='utf-8', errors='ignore')
                  original = content
                  
                  # Fix absolute paths: /path/ -> /Deploy-page/path/
                  # But NOT: //external.com or http:// or https://
                  content = re.sub(
                      r'(["\'])(/(?![/\w-]+\.(jpg|png|gif|svg|css|js|woff|woff2))(?!/)([^"\']*))',
                      r'\1' + BASE_PATH + r'\3',
                      content
                  )
                  
                  # Fix href and src starting with /
                  content = re.sub(
                      r'(href|src)="/([^/])',
                      r'\1="' + BASE_PATH + r'\2',
                      content
                  )
                  
                  if content != original:
                      file_path.write_text(content, encoding='utf-8')
                      return 1
                  return 0
              except Exception as e:
                  print(f"Error in {file_path}: {e}", file=sys.stderr)
                  return 0
          
          fixed = 0
          for html in Path('.').rglob('*.html'):
              fixed += fix_html(html)
          
          print(f"âœ… Fixed {fixed} HTML files")
          PYTHON_SCRIPT
          
          python3 fix_paths.py

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: site-content

      - name: Deploy to GitHub Pages  
        id: deployment
        uses: actions/deploy-pages@v4
