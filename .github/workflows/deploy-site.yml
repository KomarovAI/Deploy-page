name: Deploy Website to Target Repository
on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID Ð¸Ð· web-crawler (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 20479494022)'
        required: true
        type: string
      target_repo:
        description: 'Ð¦ÐµÐ»ÐµÐ²Ð¾Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ (Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: owner/repo)'
        required: true
        type: string
      target_branch:
        description: 'Ð¦ÐµÐ»ÐµÐ²Ð°Ñ Ð²ÐµÑ‚ÐºÐ° (default: main)'
        required: false
        default: 'main'
        type: string
      commit_message:
        description: 'Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°'
        required: false
        default: 'chore: deploy website'
        type: string
permissions:
  contents: read
  actions: read
jobs:
  deploy:
    name: Deploy Website to Target Repository
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    steps:
      - name: Validate inputs
        id: validate
        run: |
          echo 'ðŸ” Validating inputs...'
          RUN_ID="${{ github.event.inputs.run_id }}"
          if [[ ! "$RUN_ID" =~ ^[0-9]+$ ]]; then
            echo 'âŒ Invalid run_id format:' "$RUN_ID"
            exit 1
          fi
          TARGET_REPO="${{ github.event.inputs.target_repo }}"
          if [[ ! "$TARGET_REPO" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
            echo 'âŒ Invalid target repository format:' "$TARGET_REPO"
            exit 1
          fi
          ARTIFACT_NAME="site_archive-${RUN_ID}"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo 'âœ… Inputs validated successfully'
      - name: Checkout Deploy-page (for scripts)
        uses: actions/checkout@v4
        with:
          path: deploy-page-repo
          fetch-depth: 1
      - name: Download artifact from web-crawler
        id: download
        uses: dawidd6/action-download-artifact@v11
        with:
          github_token: ${{ secrets.EXTERNAL_REPO_PAT }}
          repo: KomarovAI/web-crawler
          run_id: ${{ steps.validate.outputs.run_id }}
          name: ${{ steps.validate.outputs.artifact_name }}
          path: site_content
          search_artifacts: true
      - name: Verify artifact
        id: verify
        run: |
          if [ ! -d "site_content" ] || [ -z "$(ls -A "site_content" 2>/dev/null)" ]; then
            echo 'âŒ Artifact not found or empty'
            ls -R .
            exit 1
          fi
          FILE_COUNT=$(find site_content -type f | wc -l)
          DIR_SIZE=$(du -sh site_content | cut -f1)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "dir_size=$DIR_SIZE" >> $GITHUB_OUTPUT
          echo 'âœ… Artifact verified:' "$FILE_COUNT files | $DIR_SIZE"
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.validate.outputs.target_repo }}
          token: ${{ secrets.EXTERNAL_REPO_PAT }}
          ref: ${{ github.event.inputs.target_branch }}
          fetch-depth: 1
              Wipe repository
        id: wipe
        run: |
          echo 'ðŸ§¹ Clearing target repository...'
          PRESERVE_FILES=(".git" ".github" ".gitignore" "README.md" "LICENSE")
          for file in "${PRESERVE_FILES[@]}"; do
            if [ -e "$file" ]; then
              mv "$file" "/tmp/${file##*/}.bak" 2>/dev/null || true
            fi
          done
          find . -mindepth 1 -maxdepth 1 -not -name '.*' -exec rm -rf {} + 2>/dev/null || true
          for file in "${PRESERVE_FILES[@]}"; do
            if [ -e "/tmp/${file##*/}.bak" ]; then
              mv "/tmp/${file##*/}.bak" "$file" 2>/dev/null || true
            fi
          done
          echo 'âœ… Repository wiped successfully'
      - name: Deploy website
        id: deploy
        run: |
          echo 'ðŸ“¦ Deploying website...'
          cp -r ../site_content/* . 2>/dev/null || true
          FILE_COUNT=$(find . -mindepth 1 -type f | wc -l)
          echo "deployed_files=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo 'âœ… Website deployed:' "$FILE_COUNT files"
      - name: Fix paths for GitHub Pages
        id: fix_paths
        run: |
          echo 'ðŸ”§ Fixing absolute paths for GitHub Pages...'
          bash "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/fix-paths.sh"
          echo 'âœ… Paths fixed successfully'
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Commit and push
        id: commit
        env:
          COMMIT_MSG: ${{ github.event.inputs.commit_message }}
          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo 'âš ï¸ No changes to commit'
            echo "status=no_changes" >> $GITHUB_OUTPUT
            exit 0
          fi
          git add -A
          git commit -m "$COMMIT_MSG"
          git push origin "$TARGET_BRANCH"
          echo "status=committed" >> $GITHUB_OUTPUT
