name: Deploy Website to Target Repository
on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID Ð¸Ð· web-crawler (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 20479494022)'
        required: true
        type: string
      target_repo:
        description: 'Ð¦ÐµÐ»ÐµÐ²Ð¾Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ (Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: owner/repo)'
        required: true
        type: string
      target_branch:
        description: 'Ð¦ÐµÐ»ÐµÐ²Ð°Ñ Ð²ÐµÑ‚ÐºÐ° (default: main)'
        required: false
        default: 'main'
        type: string
      commit_message:
        description: 'Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°'
        required: false
        default: 'chore: deploy website'
        type: string
      base_href:
        description: 'Base path for site (e.g., "/" or "/archived-sites/")'
        required: false
        default: '/'
        type: string

permissions:
  contents: read
  actions: read

jobs:
  deploy:
    name: Deploy Website to Target Repository
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      actions: read
    outputs:
      deploy_status: ${{ steps.commit.outputs.status }}
      deployed_files: ${{ steps.deploy.outputs.deployed_files }}
      commit_sha: ${{ steps.commit.outputs.commit_sha }}
    
    steps:
      - name: Validate inputs
        id: validate
        run: |
          echo 'ðŸ” Validating inputs...'
          
          # Validate run_id
          RUN_ID="${{ github.event.inputs.run_id }}"
          if [[ ! "$RUN_ID" =~ ^[0-9]+$ ]]; then
            echo 'âŒ Invalid run_id format:' "$RUN_ID"
            echo '   Expected: numeric value (e.g., 20479494022)'
            exit 1
          fi
          
          # Validate and trim target_repo
          TARGET_REPO="${{ github.event.inputs.target_repo }}"
          TARGET_REPO=$(echo "$TARGET_REPO" | xargs)  # Trim spaces
          
          # Strict format check: exactly 2 segments
          if [[ ! "$TARGET_REPO" =~ ^[a-zA-Z0-9]([a-zA-Z0-9_.-]*[a-zA-Z0-9])?/[a-zA-Z0-9]([a-zA-Z0-9_.-]*[a-zA-Z0-9])?$ ]]; then
            echo 'âŒ Invalid target repository format:' "$TARGET_REPO"
            echo '   Expected: owner/repo'
            echo '   Examples: john/my-site, org-name/project'
            exit 1
          fi
          
          # Validate base_href
          BASE_HREF="${{ github.event.inputs.base_href }}"
          if [[ ! "$BASE_HREF" =~ ^/.*/?$ ]]; then
            echo 'âŒ Invalid base_href:' "$BASE_HREF"
            echo '   Expected: path starting with / (e.g., "/" or "/project/")'
            exit 1
          fi
          
          # Ensure base_href ends with / if not root
          if [ "$BASE_HREF" != "/" ] && [[ ! "$BASE_HREF" =~ /$ ]]; then
            BASE_HREF="${BASE_HREF}/"
          fi
          
          ARTIFACT_NAME="site_archive-${RUN_ID}"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "base_href=$BASE_HREF" >> $GITHUB_OUTPUT
          echo 'âœ… Inputs validated successfully'
          echo ''
          echo "ðŸ“‹ Parameters:"
          echo "  - Run ID: $RUN_ID"
          echo "  - Target repo: $TARGET_REPO"
          echo "  - Target branch: ${{ github.event.inputs.target_branch }}"
          echo "  - Base href: $BASE_HREF"
      
      - name: Checkout Deploy-page (for scripts)
        uses: actions/checkout@v4
        with:
          path: deploy-page-repo
          fetch-depth: 1
      
      - name: Download artifact from web-crawler
        id: download
        uses: dawidd6/action-download-artifact@v11
        with:
          github_token: ${{ secrets.EXTERNAL_REPO_PAT }}
          repo: KomarovAI/web-crawler
          run_id: ${{ steps.validate.outputs.run_id }}
          name: ${{ steps.validate.outputs.artifact_name }}
          path: site_content
          search_artifacts: true
      
      - name: Verify artifact
        id: verify
        run: |
          if [ ! -d "site_content" ] || [ -z "$(ls -A "site_content" 2>/dev/null)" ]; then
            echo 'âŒ Artifact not found or empty'
            echo 'ðŸ“ Directory listing:'
            ls -R . || true
            exit 1
          fi
          FILE_COUNT=$(find site_content -type f | wc -l)
          DIR_SIZE=$(du -sh site_content | cut -f1)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "dir_size=$DIR_SIZE" >> $GITHUB_OUTPUT
          echo 'âœ… Artifact verified'
          echo "   Files: $FILE_COUNT | Size: $DIR_SIZE"
      
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.validate.outputs.target_repo }}
          token: ${{ secrets.EXTERNAL_REPO_PAT }}
          ref: ${{ github.event.inputs.target_branch }}
          fetch-depth: 0
          path: target-repo
      
      - name: Clean repository
        id: clean
        working-directory: target-repo
        run: |
          echo 'ðŸ§¹ Cleaning repository...'
          
          # Show initial state
          echo 'ðŸ“Š Initial state:'
          ls -la
          echo ''
          
          # Remove ALL files except .git and .github
          find . -mindepth 1 -maxdepth 1 \
            -not -name '.git' \
            -not -name '.github' \
            -exec rm -rf {} + 2>/dev/null || true
          
          # Hard reset git to clean state
          git reset --hard HEAD 2>/dev/null || true
          
          # Clean untracked files
          git clean -fdx 2>/dev/null || true
          
          # Remove git staging area
          git reset HEAD --hard 2>/dev/null || true
          
          # Show final state
          echo 'âœ… Repository cleaned'
          echo 'ðŸ“Š Final state:'
          ls -la
          echo ''
          echo 'Files remaining (should only be .git and .github):'
          find . -mindepth 1 -maxdepth 1 -type d -o -type f 2>/dev/null | grep -v '^\./\.' || echo '  (clean)'
      
      - name: Copy website files
        id: deploy
        run: |
          echo 'ðŸ“¦ Copying website files...'
          
          # Verify source exists
          if [ ! -d "$GITHUB_WORKSPACE/site_content" ]; then
            echo 'âŒ Source directory not found'
            exit 1
          fi
          
          # Count files to copy
          SOURCE_FILES=$(find "$GITHUB_WORKSPACE/site_content" -type f | wc -l)
          echo "Source files: $SOURCE_FILES"
          
          # Copy all content
          cp -r "$GITHUB_WORKSPACE/site_content"/* "$GITHUB_WORKSPACE/target-repo/" || {
            echo 'âŒ Failed to copy files'
            exit 1
          }
          
          # Verify copy
          DEST_FILES=$(find "$GITHUB_WORKSPACE/target-repo" -mindepth 1 -type f ! -path '*/.git/*' ! -path '*/.github/*' | wc -l)
          echo "Deployed files: $DEST_FILES"
          
          if [ "$SOURCE_FILES" -ne "$DEST_FILES" ]; then
            echo "âš ï¸  Warning: File count mismatch (source: $SOURCE_FILES, dest: $DEST_FILES)"
          fi
          
          echo "deployed_files=$DEST_FILES" >> $GITHUB_OUTPUT
          echo 'âœ… Files copied successfully'
      
      - name: Fix paths for GitHub Pages
        id: fix_paths
        working-directory: target-repo
        env:
          BASE_HREF: ${{ steps.validate.outputs.base_href }}
        run: |
          set -e
          echo 'ðŸ”§ Fixing paths for GitHub Pages...'
          echo "ðŸ“Œ Using BASE_HREF: ${BASE_HREF}"
          
          if [ ! -f "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/fix-paths.sh" ]; then
            echo 'âŒ fix-paths.sh script not found'
            exit 1
          fi
          
          bash "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/fix-paths.sh" || {
            echo 'âŒ Path fixing script failed'
            exit 1
          }
          
          echo 'âœ… Paths fixed successfully'
      
      - name: Validate deployment
        id: validate_deploy
        working-directory: target-repo
        run: |
          echo 'âœ”ï¸ Validating deployment...'
          
          if [ ! -f "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/validate-deploy.sh" ]; then
            echo 'âš ï¸  validate-deploy.sh not found, skipping validation'
          else
            bash "$GITHUB_WORKSPACE/deploy-page-repo/.github/scripts/validate-deploy.sh" || {
              echo 'âš ï¸  Validation completed with warnings'
            }
          fi
          
          echo 'âœ… Validation step completed'
      
      - name: Configure git
        working-directory: target-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo 'âœ… Git configured'
      
      - name: Stage files and commit
        id: commit
        working-directory: target-repo
        env:
          COMMIT_MSG: ${{ github.event.inputs.commit_message }}
          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
        run: |
          echo 'ðŸ“ Staging and committing files...'
          
          # Show git status before
          echo 'ðŸ“Š Git status before:'
          git status --short || echo '  (clean)'
          echo ''
          
          # Add all files
          git add -A --force
          
          # Show what will be committed
          echo 'ðŸ“‹ Files staged for commit:'
          git diff --cached --name-status || echo '  (none)'
          echo ''
          
          # Check if there are changes to commit
          if ! git diff-index --quiet HEAD --; then
            echo 'âœ… Changes detected, creating commit...'
            git commit -m "$COMMIT_MSG" -m "Deploy: $COMMIT_MSG at $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || {
              echo 'âŒ Commit failed!'
              exit 1
            }
          else
            echo 'âš ï¸  No staged changes, creating empty commit...'
            git commit --allow-empty -m "$COMMIT_MSG" -m "Deploy: $COMMIT_MSG at $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || {
              echo 'âŒ Empty commit failed!'
              exit 1
            }
          fi
          
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "status=success" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "âœ… Commit created: $COMMIT_SHA"
      
      - name: Force push to target branch
        id: push
        working-directory: target-repo
        env:
          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
        run: |
          echo 'ðŸš€ Force pushing to '"$TARGET_BRANCH"'...'
          
          # Show log
          echo 'ðŸ“ Last commits:'
          git log --oneline -n 5 || true
          echo ''
          
          # Force push with verbose output
          if git push --force --verbose origin "$TARGET_BRANCH"; then
            echo ''
            echo 'âœ… Force push successful'
            echo "branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          else
            echo ''
            echo 'âŒ Force push failed!'
            git status
            exit 1
          fi
      
      - name: Create deployment summary
        if: always()
        run: |
          echo "# ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.commit.outputs.status }}" = "success" ]; then
            echo "**Status:** âœ… **SUCCESS (DEPLOYED)**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ“Š Details" >> $GITHUB_STEP_SUMMARY
            echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Repository | [\`${{ steps.validate.outputs.target_repo }}\`](https://github.com/${{ steps.validate.outputs.target_repo }}) |" >> $GITHUB_STEP_SUMMARY
            echo "| Branch | \`${{ github.event.inputs.target_branch }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Commit | [\`${{ steps.commit.outputs.commit_sha }}\`](https://github.com/${{ steps.validate.outputs.target_repo }}/commit/${{ steps.commit.outputs.commit_sha }}) |" >> $GITHUB_STEP_SUMMARY
            echo "| Files Deployed | **${{ steps.deploy.outputs.deployed_files }}** |" >> $GITHUB_STEP_SUMMARY
            echo "| Artifact Size | ${{ steps.verify.outputs.dir_size }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Message | \`${{ github.event.inputs.commit_message }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Base href | \`${{ steps.validate.outputs.base_href }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ **FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Repository](https://github.com/${{ steps.validate.outputs.target_repo }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Commits](https://github.com/${{ steps.validate.outputs.target_repo }}/commits/${{ github.event.inputs.target_branch }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Deployed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
